name: AutoPost (daily 09:30 KST)

on:
  workflow_dispatch:
  schedule:
    - cron: '30 0 * * *'   # 매일 00:30 UTC == 09:30 KST

permissions:
  contents: write

concurrency:
  group: daily-run
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-24.04
    env:
      AFFILIATE_TIMES_KST: '12:00,16:00,18:00'
      POST_STATUS: future
      REQUIRE_COUPANG_API: '1'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write .env from secrets
        run: |
          cat > .env <<'EOF'
          WP_URL=${{ secrets.WP_URL }}
          WP_USER=${{ secrets.WP_USER }}
          WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD }}
          WP_TLS_VERIFY=true
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          MAX_TOKENS_BODY=900
          COUPANG_ACCESS_KEY=${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY=${{ secrets.COUPANG_SECRET_KEY }}
          COUPANG_CHANNEL_ID=${{ secrets.COUPANG_CHANNEL_ID }}
          COUPANG_SUBID_PREFIX=auto
          REQUIRE_COUPANG_API=${{ env.REQUIRE_COUPANG_API }}
          POST_STATUS=${{ env.POST_STATUS }}
          KEYWORDS_CSV=keywords_general.csv
          EXISTING_CATEGORIES=뉴스,비공개,쇼핑,전체글,게시글,정보,취미
          PRODUCTS_SEED_CSV=products_seed.csv
          DEFAULT_CATEGORY=정보
          AFFILIATE_CATEGORY=쇼핑
          DISCLOSURE_TEXT=이 포스팅은 쿠팡 파트너스 활동의 일환으로, 이에 따른 일정액의 수수료를 제공합니다.
          USER_AGENT=gpt-blog-keywords/1.3
          USAGE_DIR=.usage
          LLM_LOG_FILENAME=llm.log
          AFFILIATE_TIMES_KST=${{ env.AFFILIATE_TIMES_KST }}
          AD_SHORTCODE=${{ secrets.AD_SHORTCODE }}
          EOF

      - name: Update keywords (optional)
        run: |
          if [ -f update_keywords.py ]; then
            python update_keywords.py --k 50 --gold 20 --shop-k 50 --shop-gold 20 --days 7 --parallel 8 || true
          fi
          head -n 5 golden_shopping_keywords.csv || true

      - name: Build seed via Coupang API (best-effort)
        run: |
          set +e
          if [ -f build_products_seed.py ]; then
            python build_products_seed.py || echo "[build_products_seed] WARN: non-zero exit (ignored)"
          fi
          if [ ! -s "${PRODUCTS_SEED_CSV:-products_seed.csv}" ]; then
            echo "product_name,raw_url,pros,cons,keyword,title,url,image" > "${PRODUCTS_SEED_CSV:-products_seed.csv}"
          fi

      - name: Ensure usage dir
        run: |
          mkdir -p .usage
          [ -f .usage/.gitkeep ] || touch .usage/.gitkeep

      - name: Post diary (two posts)
        run: |
          if [ -f auto_wp_gpt.py ]; then
            python auto_wp_gpt.py --mode=two-posts
          fi

      - name: Post affiliate (runs per slot)
        run: |
          set -o pipefail
          IFS=',' read -r -a TIMES <<< "$AFFILIATE_TIMES_KST"
          for t in "${TIMES[@]}"; do
            echo "[AFFILIATE] slot=$t"
            AFFILIATE_TIME_KST="$t" python affiliate_post.py 2>&1 | tee -a /tmp/affiliate_out.txt || true
          done
          echo "---- Affiliate tail ----"; tail -n 200 /tmp/affiliate_out.txt || true
          echo "---- used_shopping tail ----"; tail -n 50 .usage/used_shopping.txt || true

      - name: Commit rotated keywords & usage logs
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase origin "${GITHUB_REF_NAME:-main}" || true
          git add -f golden_shopping_keywords.csv keywords_shopping.csv keywords_general.csv .usage/ || true
          if git diff --cached --quiet; then
            echo "[INFO] nothing to commit"
          else
            git commit -m "chore: rotate keywords & persist usage logs (auto)"
            git push
          fi
