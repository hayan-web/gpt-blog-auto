name: Daily 3 Posts (auto keywords + 2 daily + 1 affiliate + rotate)

on:
  schedule:
    - cron: "5 0 * * *"   # 매일 09:05 KST (UTC 00:05)
  workflow_dispatch: {}

concurrency:
  group: autopost
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write .env from Secrets (do not commit secrets)
        run: |
          cat > .env << EOF
          # ===== WordPress =====
          WP_URL=${{ secrets.WP_URL }}
          WP_USER=${{ secrets.WP_USER }}
          WP_APP_PASSWORD=${{ secrets.WP_APP_PASSWORD }}
          WP_TLS_VERIFY=${{ secrets.WP_TLS_VERIFY }}
          # ===== OpenAI =====
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}
          OPENAI_MODEL_LONG=${{ secrets.OPENAI_MODEL_LONG }}
          MAX_TOKENS_BODY=900
          # ===== Coupang Partners =====
          COUPANG_ACCESS_KEY=${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY=${{ secrets.COUPANG_SECRET_KEY }}
          COUPANG_CHANNEL_ID=${{ secrets.COUPANG_CHANNEL_ID }}
          COUPANG_SUBID_PREFIX=${{ secrets.COUPANG_SUBID_PREFIX }}
          REQUIRE_COUPANG_API=${{ secrets.REQUIRE_COUPANG_API }}
          AFFILIATE_TIME_KST=${{ secrets.AFFILIATE_TIME_KST }}
          # ===== Posting / Taxonomy =====
          POST_STATUS=future
          KEYWORDS_CSV=keywords.csv
          ALLOW_CREATE_TERMS=${{ secrets.ALLOW_CREATE_TERMS }}
          EXISTING_CATEGORIES=뉴스,비공개,쇼핑,전체글,게시글,정보,취미
          # ===== Affiliate Content =====
          PRODUCTS_SEED_CSV=products_seed.csv
          DEFAULT_CATEGORY=정보
          DEFAULT_TAGS=
          AFFILIATE_CATEGORY=쇼핑
          AFFILIATE_TAGS=
          DISCLOSURE_TEXT=이 포스팅은 쿠팡 파트너스 활동의 일환으로, 이에 따른 일정액의 수수료를 제공받습니다.
          # ===== Ads =====
          AD_METHOD=${{ secrets.AD_METHOD }}
          AD_SHORTCODE=${{ secrets.AD_SHORTCODE }}
          AD_INSERT_MIDDLE=${{ secrets.AD_INSERT_MIDDLE }}
          # ===== Keywords Auto Update =====
          NEWSAPI_KEY=${{ secrets.NEWSAPI_KEY }}
          NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
          KEYWORDS_K=10
          BAN_KEYWORDS=${{ secrets.BAN_KEYWORDS }}
          BACKUP_OLD_KEYWORDS=true
          USER_AGENT=gpt-blog-keywords/1.2
          # ===== Cache / Logs =====
          USAGE_DIR=.usage
          CACHE_DIR=.cache
          LLM_LOG_FILENAME=llm.log
          CACHE_TTL_DEFAULT=86400
          CACHE_MAX_FILES=500
          CACHE_DISABLE=false
          # ===== Flow switches =====
          KEYWORD_PICK_MODE=${{ secrets.KEYWORD_PICK_MODE }}   # random | rotate | first
          SEED_PICK_MODE=${{ secrets.SEED_PICK_MODE }}         # rank | shuffle | rotate
          USE_IMAGE=${{ secrets.USE_IMAGE }}                   # off | hotlink | upload
          BUTTON_TEXT=${{ secrets.BUTTON_TEXT }}               # 비우면 랜덤 CTA
          # ===== Debug =====
          DRY_RUN=
          EOF

      # Preflight: run 블록에서만 secrets 사용 (YAML 파싱 오류 방지)
      - name: Preflight (Coupang keys present?)
        run: |
          if [ -n "${{ secrets.COUPANG_ACCESS_KEY }}" ] && [ -n "${{ secrets.COUPANG_SECRET_KEY }}" ]; then
            echo "[OK] Coupang keys are set."
          else
            echo "[WARN] COUPANG_ACCESS_KEY/SECRET_KEY empty -> API 검색/딥링크는 폴백 사용"
          fi

      # 0) 오늘 키워드 수집/검수/분리(일반·쇼핑) + 골든 생성 (병렬)
      - name: Update keywords (일반+쇼핑, 자동검수, 병렬)
        run: |
          if [ -f update_keywords.py ]; then
            python update_keywords.py --k 10 --gold 5 --shop-k 12 --shop-gold 5 --days 3 --parallel 8 || true
          else
            echo "SKIP: update_keywords.py not found"
          fi

      # 0.1) 키워드 안전 폴백(수집 실패 시라도 비어있지 않도록 보장)
      - name: Ensure non-empty keyword files (safety fallback)
        run: |
          python - << 'PY'
          import os,random,datetime
          def write_once(path, lines, header=None, col=False):
              if os.path.exists(path):
                  txt=open(path,'r',encoding='utf-8',errors='ignore').read().strip()
                  if txt: return
              os.makedirs(os.path.dirname(path), exist_ok=True) if '/' in path else None
              if col:
                  with open(path,'w',encoding='utf-8') as f:
                      if header: f.write(header+"\n")
                      for x in lines: f.write(x+"\n")
              else:
                  with open(path,'w',encoding='utf-8') as f:
                      f.write(",".join(lines)+"\n")
          m=datetime.date.today().month
          summer=["무더위 꿀팁","열대야 이기는 법","시원한 집중 루틴","여름 건강 수분전략",
                  "땀과 컨디션 관리","여름 밤 숙면 체크","햇빛과 멜라토닌","체온과 생산성"]
          winter=["따뜻한 생산성 루틴","한파 컨디션 유지","면역과 수면 리듬","겨울 운동의 핵심",
                  "차가운 손발 순환","비타민D와 기분","보온과 호흡","겨울 우울 탈출"]
          general = summer if m in (6,7,8,9) else winter
          shopping = ["넥쿨러","휴대용 선풍기","아이스 넥밴드","쿨링 타월","공기청정기","무선 청소기","가습기","전기요"]
          random.shuffle(general); random.shuffle(shopping)
          write_once("keywords_general.csv", general[:10], header="keyword", col=True)
          write_once("golden_keywords.csv", general[:5], header="keyword", col=True)
          write_once("keywords_shopping.csv", shopping[:12], header="keyword", col=True)
          write_once("golden_shopping_keywords.csv", shopping[:5], header="keyword", col=True)
          if not os.path.exists("keywords.csv"):
              write_once("keywords.csv", general[:10])
          PY

      # 디버그: 키워드 파일 헤드 출력
      - name: Show keyword heads (debug)
        run: |
          echo "== golden_shopping_keywords.csv (head) =="; head -n 5 golden_shopping_keywords.csv || true
          echo "== keywords_shopping.csv (head) =="; head -n 5 keywords_shopping.csv || true
          echo "== keywords_general.csv (head) =="; head -n 5 keywords_general.csv || true
          echo "== keywords.csv (line) =="; if [ -f keywords.csv ]; then head -n 1 keywords.csv; fi

      # 1) (선택) 쿠팡 씨앗 빌드 — 키 없으면 다음 단계에서 폴백 처리
      - name: Build products_seed (from Coupang API)
        run: |
          if [ -f build_products_seed.py ]; then
            python build_products_seed.py || true
          else
            echo "SKIP: build_products_seed.py not found"
          fi

      # 2) (선택) 씨앗 품질 체크 — 실패해도 워크플로 지속
      - name: Seed quality check (report + cleaned csv)
        run: |
          if [ -f seed_quality_check.py ]; then
            python seed_quality_check.py --strict --write-clean --http-fallback --max-per-keyword 5 --report .cache/seed_report.md || \
            python seed_quality_check.py --write-clean --no-network --max-per-keyword 5 --report .cache/seed_report.md || true
          else
            echo "SKIP: seed_quality_check.py not found"
          fi

      # 3) 일상글 2건 예약 (10:00 / 17:00 KST)
      - name: Schedule 2 daily posts (10:00 / 17:00 KST)
        run: |
          if [ -f auto_wp_gpt.py ]; then
            python auto_wp_gpt.py --mode=two-posts
          else
            echo "SKIP: auto_wp_gpt.py not found"
          fi

      # 4) 쿠팡글 1건 예약 (13:00 KST) + 키워드 회전
      - name: Schedule 1 affiliate post (13:00 KST) and rotate keywords
        run: |
          set -o pipefail
          if [ -f affiliate_post.py ]; then
            python affiliate_post.py 2>&1 | tee /tmp/affiliate_out.txt || true
          else
            echo "SKIP: affiliate_post.py not found" | tee /tmp/affiliate_out.txt
          fi
          echo "---- Affiliate step tail ----"
          tail -n 120 /tmp/affiliate_out.txt || true
          if grep -q '"post_id"' /tmp/affiliate_out.txt; then
            echo "[OK] affiliate post created/scheduled. Rotating keywords..."
            if [ -f rotate_keywords.py ]; then python rotate_keywords.py; fi
          else
            echo "[INFO] Affiliate post not created. See [AFFILIATE] lines above for reason."
          fi
